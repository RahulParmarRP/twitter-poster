<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Offline Image Organizer</title>
  <style>
    ul { list-style-type: none; padding-left: 20px; }
    li { cursor: pointer; user-select: none; }
    li.file { cursor: default; }
    li.clickable-file { cursor: pointer; color: #0066cc; }
    #folder-tree { border: 1px solid #ccc; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
    #organization-preview { border: 1px solid #0066cc; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; background-color: #f9f9f9; }
    #file-details { border: 1px solid #999; padding: 10px; margin: 10px 0; background-color: #f5f5f5; max-height: 400px; overflow-y: auto; }
    .month-folder { font-weight: bold; color: #0066cc; }
    .image-file { color: #333; margin-left: 20px; }
    .organization-options { background-color: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .organization-options label { margin-right: 20px; cursor: pointer; }
    .files-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .files-table th, .files-table td { border: 1px solid #ddd; padding: 4px; text-align: left; }
    .files-table th { background-color: #f2f2f2; font-weight: bold; }
    .files-table tr:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <h2>Offline Image Organizer</h2>

  <button id="select-folder">1. Select Folder</button>
  <button id="read-files" disabled>2. Read Images</button>
  
  <div class="organization-options" id="organization-options" style="display:none;">
    <strong>Organization Type:</strong><br><br>
    <label><input type="radio" name="organization" value="monthly" checked> Monthly Albums (2025-08)</label>
    <label><input type="radio" name="organization" value="daily"> Daily Albums (2025-08-30)</label>
  </div>
  
  <button id="visualize" disabled>2.5. Visualize Organization</button>
  <button id="organize" disabled>3. Organize Images</button>

  <div id="status"></div>
  <div id="folder-tree"></div>
  <div id="file-details">
    <h3>File Details</h3>
    <div id="files-table-container"></div>
  </div>
  <div id="organization-preview"></div>

  <script>
    let rootHandle = null;
    let imageFiles = [];

    const status = document.getElementById("status");
    const selectFolderBtn = document.getElementById("select-folder");
    const readFilesBtn = document.getElementById("read-files");
    const visualizeBtn = document.getElementById("visualize");
    const organizeBtn = document.getElementById("organize");
    const folderTreeDiv = document.getElementById("folder-tree");
    const organizationPreviewDiv = document.getElementById("organization-preview");
    const organizationOptionsDiv = document.getElementById("organization-options");
    const filesTableContainer = document.getElementById("files-table-container");
    let allFiles = [];

    // Get all file properties without any filtering
    async function getFileProperties(fileHandle, folderPath = '') {
      try {
        const file = await fileHandle.getFile();
        const properties = {
          path: folderPath
        };

        // Add absolutely everything from the file object
        for (const key in file) {
          properties[key] = file[key];
        }

        return properties;
      } catch (err) {
        return { name: fileHandle.name, error: 'Could not read file' };
      }
    }

    // Display all files in table format
    function displayFilesTable(files) {
      if (!files.length) {
        filesTableContainer.innerHTML = '<p>No files found</p>';
        return;
      }

      // Get all unique property keys
      const allKeys = new Set();
      files.forEach(file => {
        Object.keys(file).forEach(key => allKeys.add(key));
      });

      const keys = Array.from(allKeys).sort();

      let tableHTML = '<table class="files-table"><thead><tr>';
      keys.forEach(key => {
        tableHTML += `<th>${key}</th>`;
      });
      tableHTML += '</tr></thead><tbody>';

      files.forEach(file => {
        tableHTML += '<tr>';
        keys.forEach(key => {
          let value = file[key];
          // Display everything as-is, no truncation or filtering
          tableHTML += `<td>${value}</td>`;
        });
        tableHTML += '</tr>';
      });

      tableHTML += '</tbody></table>';
      filesTableContainer.innerHTML = tableHTML;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Get selected organization type
    function getOrganizationType() {
      return document.querySelector('input[name="organization"]:checked').value;
    }

    // Generate folder name based on organization type
    function getFolderName(date, type) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      
      if (type === 'daily') {
        return `${year}-${month}-${day}`;
      } else {
        return `${year}-${month}`;
      }
    }

    // Get display name for folder
    function getFolderDisplayName(folderName, type) {
      if (type === 'daily') {
        const [year, month, day] = folderName.split('-');
        const date = new Date(year, month - 1, day);
        return `${folderName} (${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })})`;
      } else {
        const [year, month] = folderName.split('-');
        const date = new Date(year, month - 1);
        return `${folderName} (${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })})`;
      }
    }

    // Step 1: Select root folder and read all file properties
    selectFolderBtn.addEventListener("click", async () => {
      try {
        rootHandle = await window.showDirectoryPicker();
        status.innerText = "Reading folder and file properties...";
        readFilesBtn.disabled = false;
        
        // Read all files and their properties
        allFiles = [];
        folderTreeDiv.innerHTML = '';
        const ul = document.createElement('ul');
        await buildTree(rootHandle, ul, '');
        folderTreeDiv.appendChild(ul);
        
        // Display all file properties
        displayFilesTable(allFiles);
        status.innerText = `Found ${allFiles.length} files with properties displayed below.`;
      } catch (err) {
        console.error(err);
        status.innerText = "Folder selection cancelled or error.";
      }
    });

    // Build folder tree and collect all file properties
    async function buildTree(dirHandle, parentElement, currentPath) {
      for await (const entry of dirHandle.values()) {
        const li = document.createElement('li');
        li.textContent = entry.name;
        
        const fullPath = currentPath ? `${currentPath}/${entry.name}` : entry.name;

        if (entry.kind === 'directory') {
          li.addEventListener('click', e => {
            e.stopPropagation();
            const childUl = li.querySelector('ul');
            if (childUl) {
              childUl.style.display = childUl.style.display === 'none' ? 'block' : 'none';
            }
          });

          const childUl = document.createElement('ul');
          await buildTree(entry, childUl, fullPath);
          li.appendChild(childUl);
        } else {
          li.classList.add('file');
          
          // Get file properties and add to allFiles array
          const fileProps = await getFileProperties(entry, currentPath);
          allFiles.push(fileProps);
        }

        parentElement.appendChild(li);
      }
    }

    // Step 2: Read all images recursively
    async function readFiles(folderHandle) {
      const files = [];
      for await (const entry of folderHandle.values()) {
        if (entry.kind === "file" && /\.(jpe?g|png|gif|bmp|webp|heic|raw|tiff?)$/i.test(entry.name)) {
          files.push(entry);
        } else if (entry.kind === "directory") {
          files.push(...await readFiles(entry));
        }
      }
      return files;
    }

    readFilesBtn.addEventListener("click", async () => {
      if (!rootHandle) return;
      status.innerText = "Reading image files...";
      
      // Filter image files from allFiles array
      imageFiles = allFiles.filter(fileProps => 
        /\.(jpe?g|png|gif|bmp|webp|heic|raw|tiff?)$/i.test(fileProps.name)
      );
      
      status.innerText = `${imageFiles.length} images found. Choose organization type.`;
      
      // Show organization options
      organizationOptionsDiv.style.display = 'block';
      visualizeBtn.disabled = false;
      organizeBtn.disabled = false;
    });

    // Step 2.5: Visualize Organization
    visualizeBtn.addEventListener("click", async () => {
      if (!imageFiles.length) return;
      status.innerText = "Visualizing organization...";
      
      const organizationType = getOrganizationType();
      
      // Group images by selected organization type
      const groups = {};
      
      for (const fileProps of imageFiles) {
        const date = new Date(fileProps.lastModified);
        const folderName = getFolderName(date, organizationType);
        
        if (!groups[folderName]) {
          groups[folderName] = [];
        }
        groups[folderName].push(fileProps.name);
      }

      // Build preview tree
      organizationPreviewDiv.innerHTML = `<h3>Organization Preview (${organizationType === 'daily' ? 'Daily' : 'Monthly'}):</h3>`;
      const previewUl = document.createElement('ul');
      
      // Sort folders
      const sortedFolders = Object.keys(groups).sort();
      
      for (const folderName of sortedFolders) {
        const folderLi = document.createElement('li');
        folderLi.className = 'month-folder';
        const displayName = getFolderDisplayName(folderName, organizationType);
        folderLi.textContent = `📁 ${displayName} (${groups[folderName].length} images)`;
        
        // Add click to toggle
        folderLi.addEventListener('click', e => {
          e.stopPropagation();
          const childUl = folderLi.querySelector('ul');
          if (childUl) {
            childUl.style.display = childUl.style.display === 'none' ? 'block' : 'none';
          }
        });
        
        const filesUl = document.createElement('ul');
        for (const fileName of groups[folderName]) {
          const fileLi = document.createElement('li');
          fileLi.className = 'image-file';
          fileLi.textContent = `• ${fileName}`;
          filesUl.appendChild(fileLi);
        }
        
        folderLi.appendChild(filesUl);
        previewUl.appendChild(folderLi);
      }
      
      organizationPreviewDiv.appendChild(previewUl);
      status.innerText = `Preview ready: ${sortedFolders.length} ${organizationType === 'daily' ? 'daily' : 'monthly'} folders will be created.`;
    });

    // Note: Organization functionality removed to focus on file properties display
    organizeBtn.addEventListener("click", async () => {
      status.innerText = "Organization feature temporarily disabled. Focus is on displaying file properties.";
    });
  </script>
</body>
</html>