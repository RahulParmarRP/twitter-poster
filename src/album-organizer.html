<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Offline Image Organizer</title>
  <style>
    ul { list-style-type: none; padding-left: 20px; }
    li { cursor: pointer; user-select: none; }
    li.file { cursor: default; }
    #folder-tree { border: 1px solid #ccc; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
    #organization-preview { border: 1px solid #0066cc; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; background-color: #f9f9f9; }
    .month-folder { font-weight: bold; color: #0066cc; }
    .image-file { color: #333; margin-left: 20px; }
  </style>
</head>
<body>
  <h2>Offline Image Organizer</h2>

  <button id="select-folder">1. Select Folder</button>
  <button id="read-files" disabled>2. Read Images</button>
  <button id="visualize" disabled>2.5. Visualize Organization</button>
  <button id="organize" disabled>3. Organize by Month</button>

  <div id="status"></div>
  <div id="folder-tree"></div>
  <div id="organization-preview"></div>

  <script>
    let rootHandle = null;
    let imageFiles = [];

    const status = document.getElementById("status");
    const selectFolderBtn = document.getElementById("select-folder");
    const readFilesBtn = document.getElementById("read-files");
    const visualizeBtn = document.getElementById("visualize");
    const organizeBtn = document.getElementById("organize");
    const folderTreeDiv = document.getElementById("folder-tree");
    const organizationPreviewDiv = document.getElementById("organization-preview");

    // Step 1: Select root folder and show tree
    selectFolderBtn.addEventListener("click", async () => {
      try {
        rootHandle = await window.showDirectoryPicker();
        status.innerText = "Folder selected.";
        readFilesBtn.disabled = false;
        
        // Show folder tree
        folderTreeDiv.innerHTML = '';
        const ul = document.createElement('ul');
        await buildTree(rootHandle, ul);
        folderTreeDiv.appendChild(ul);
      } catch (err) {
        console.error(err);
        status.innerText = "Folder selection cancelled or error.";
      }
    });

    // Build folder tree view
    async function buildTree(dirHandle, parentElement) {
      for await (const entry of dirHandle.values()) {
        const li = document.createElement('li');
        li.textContent = entry.name;

        if (entry.kind === 'directory') {
          li.addEventListener('click', e => {
            e.stopPropagation();
            const childUl = li.querySelector('ul');
            if (childUl) {
              childUl.style.display = childUl.style.display === 'none' ? 'block' : 'none';
            }
          });

          const childUl = document.createElement('ul');
          await buildTree(entry, childUl);
          li.appendChild(childUl);
        } else {
          li.classList.add('file');
        }

        parentElement.appendChild(li);
      }
    }

    // Step 2: Read all images recursively
    async function readFiles(folderHandle) {
      const files = [];
      for await (const entry of folderHandle.values()) {
        if (entry.kind === "file" && /\.(jpe?g|png)$/i.test(entry.name)) {
          files.push(entry);
        } else if (entry.kind === "directory") {
          files.push(...await readFiles(entry));
        }
      }
      return files;
    }

    readFilesBtn.addEventListener("click", async () => {
      if (!rootHandle) return;
      status.innerText = "Reading files...";
      imageFiles = await readFiles(rootHandle);
      status.innerText = `${imageFiles.length} images found. Ready to visualize or organize.`;
      visualizeBtn.disabled = false;
      organizeBtn.disabled = false;
    });

    // Step 2.5: Visualize Organization
    visualizeBtn.addEventListener("click", async () => {
      if (!imageFiles.length) return;
      status.innerText = "Visualizing organization...";
      
      // Group images by month
      const monthGroups = {};
      
      for (const fileHandle of imageFiles) {
        const file = await fileHandle.getFile();
        const date = new Date(file.lastModified);
        const monthFolderName = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,"0")}`;
        
        if (!monthGroups[monthFolderName]) {
          monthGroups[monthFolderName] = [];
        }
        monthGroups[monthFolderName].push(file.name);
      }

      // Build preview tree
      organizationPreviewDiv.innerHTML = '<h3>Organization Preview:</h3>';
      const previewUl = document.createElement('ul');
      
      // Sort months
      const sortedMonths = Object.keys(monthGroups).sort();
      
      for (const monthFolder of sortedMonths) {
        const monthLi = document.createElement('li');
        monthLi.className = 'month-folder';
        monthLi.textContent = `📁 ${monthFolder} (${monthGroups[monthFolder].length} images)`;
        
        // Add click to toggle
        monthLi.addEventListener('click', e => {
          e.stopPropagation();
          const childUl = monthLi.querySelector('ul');
          if (childUl) {
            childUl.style.display = childUl.style.display === 'none' ? 'block' : 'none';
          }
        });
        
        const filesUl = document.createElement('ul');
        for (const fileName of monthGroups[monthFolder]) {
          const fileLi = document.createElement('li');
          fileLi.className = 'image-file';
          fileLi.textContent = `• ${fileName}`;
          filesUl.appendChild(fileLi);
        }
        
        monthLi.appendChild(filesUl);
        previewUl.appendChild(monthLi);
      }
      
      organizationPreviewDiv.appendChild(previewUl);
      status.innerText = `Preview ready: ${sortedMonths.length} month folders will be created.`;
    });

    // Step 3: Organize by month
    organizeBtn.addEventListener("click", async () => {
      if (!imageFiles.length) return;
      status.innerText = "Organizing images...";

      for (const fileHandle of imageFiles) {
        const file = await fileHandle.getFile();
        const date = new Date(file.lastModified);
        const monthFolderName = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,"0")}`;

        let monthFolder = await rootHandle.getDirectoryHandle(monthFolderName, { create: true });
        const newFileHandle = await monthFolder.getFileHandle(file.name, { create: true });
        const writable = await newFileHandle.createWritable();
        await writable.write(await file.arrayBuffer());
        await writable.close();
      }

      // Refresh tree after organizing
      folderTreeDiv.innerHTML = '';
      const ul = document.createElement('ul');
      await buildTree(rootHandle, ul);
      folderTreeDiv.appendChild(ul);

      status.innerText = "Images organized successfully!";
    });
  </script>
</body>
</html>